generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id           String            @id @default(cuid())
  email        String            @unique
  password     String?
  username     String            @unique
  isActive     Boolean           @default(true)
  googleId     String?           @unique
  facebookId   String?           @unique
  roleId       Int               @default(1)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  comments     Comment[]
  inventories  Inventory[]
  accesses     InventoryAccess[]
  itemsCreated Item[]
  likedItems   ItemLike[]
  role         Role              @relation(fields: [roleId], references: [id])
}

model Category {
  id          String      @id @default(cuid())
  name        String      @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventories Inventory[]
}

model Inventory {
  id              String            @id @default(cuid())
  title           String
  description     String?
  version         Int               @default(1)
  ownerId         String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isPublic        Boolean           @default(true)
  categoryId      String?
  itemsCount      Int               @default(0)
  customIdFormat  Json?
  comments        Comment[]
  customFields    CustomField[]
  category        Category?         @relation(fields: [categoryId], references: [id])
  owner           User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  accesses        InventoryAccess[]
  tags            InventoryTag[]
  items           Item[]
  sequenceCounter SequenceCounter?
}

model InventoryAccess {
  id          String    @id @default(cuid())
  inventoryId String
  userId      String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([inventoryId, userId])
}

model Item {
  id           String             @id @default(cuid())
  inventoryId  String
  customId     String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  description  String
  name         String
  likesCount   Int                @default(0)
  creatorId    String?
  version      Int                @default(1)
  author       String
  pages        Int
  year         Int
  customValues CustomFieldValue[]
  creator      User?              @relation(fields: [creatorId], references: [id])
  inventory    Inventory          @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  likes        ItemLike[]

  @@unique([inventoryId, customId])
  @@index([inventoryId])
}

model Comment {
  id          String    @id @default(cuid())
  content     String
  inventoryId String
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
}

model CustomField {
  id          String             @id @default(cuid())
  inventoryId String
  name        String
  type        FieldType
  createdAt   DateTime           @default(now())
  description String?
  order       Int?
  showInTable Boolean            @default(true)
  updatedAt   DateTime           @updatedAt
  inventory   Inventory          @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  values      CustomFieldValue[]

  @@unique([inventoryId, name])
}

model CustomFieldValue {
  id            String      @id @default(cuid())
  itemId        String
  customFieldId String
  value         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  item          Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([itemId, customFieldId])
}

model ItemLike {
  id        String   @id @default(cuid())
  itemId    String
  userId    String
  createdAt DateTime @default(now())
  item      Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
  @@index([userId])
}

model Tag {
  id          String         @id @default(cuid())
  name        String         @unique
  inventories InventoryTag[]
}

model InventoryTag {
  inventoryId String
  tagId       String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  tag         Tag       @relation(fields: [tagId], references: [id])

  @@id([inventoryId, tagId])
}

model SequenceCounter {
  id           String    @id @default(cuid())
  inventoryId  String    @unique
  currentValue Int       @default(0)
  updatedAt    DateTime  @updatedAt
  createdAt    DateTime  @default(now())
  inventory    Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
}

enum FieldType {
  SINGLE_LINE
  MULTI_LINE
  NUMERIC
  LINK
  BOOLEAN
}
